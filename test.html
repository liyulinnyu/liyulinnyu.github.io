<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <link rel="stylesheet" href="">
</head>
<style>
    #thecanvas{
        position: absolute;
        top:0;
        left:0;
        background: #000;
    }
</style>
<body>
    


    <script>

    (function(){

        var totalwidth = window.innerWidth;
        var totalheight = window.innerHeight;

        var canvas = "<canvas id='thecanvas' width='"+totalwidth+"px' height='"+totalheight+"px'></canvas>";
        document.body.insertAdjacentHTML("beforeEnd", canvas);
        var thecanvas = document.querySelector("#thecanvas");
        var context = thecanvas.getContext("2d");

        var nyuimg = new Image();
        nyuimg.src = "img/nyu.jpg";

        // 画背景图片
        nyuimg.onload = function(){
            
        }

        window.addEventListener("load", canvasApp, false);

        function canvasApp(){
            context.drawImage(nyuimg, totalwidth*0.5-100, totalheight*0.5-100, 200, 200);
            var imgdata = context.getImageData(totalwidth*0.5-100, totalheight*0.5-100, 200, 200);
            var particles = [];
            var cols = 200,
                rows = 200,
                s_cols = parseInt(imgdata.width/cols),
                s_rows = parseInt(imgdata.height/rows),
                pos = 0, // 粒子在data中的位置
                data = imgdata.data;   // 整体数值
            for (var i = 0; i < cols; i++){
                for (var j = 0; j < rows; j++){
                    var pos = [(j*s_rows - 1)*imgdata.width + (i*s_cols - 1)]*4;
                    // 判断是否符合标准
                    if (data[pos] > 50){
                        var particle = {
                            x : totalwidth*0.5-100 + i*s_cols + (Math.random()-0.5)*20,
                            y : totalheight*0.5-100 + j*s_rows + (Math.random()-0.5)*20,
                            fillStyle : "rgb("+data[pos]+","+data[pos+1]+","+data[pos+2]+")"
                        }
                        particles.push(particle);
                    }
                }
            }
            
            draw();                  
        }

        // 放函数里不行？？ 为什么: 同源！！
        
        function draw(){
            context.clearRect(0, 0, totalwidth, totalheight);

            var speed = 1; // 速度是一样的
            for (i = 0; i < particles.length; i++){
                context.fillStyle = particles[i].fillStyle;
                context.fillRect(particles[i].x, particles[i].y, 1, 1);

                particles[i].y -= (totalheight-particles[i].y)*0.01;
            }  

            
            requestId = requestAnimationFrame(draw);   
        }






    })();
    

    </script>
    
</body>
</html>